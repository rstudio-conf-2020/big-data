```{r, include = FALSE}
library(data.table)
library(dtplyr)
library(dplyr)
library(lobstr)
#knitr::opts_chunk$set(eval = FALSE)
```

# Introduction to `dtplyr`

## `dtplyr` basics
*Load data into R via `data.table`, and then wrap it with `dtplyr`*

1. Load the `data.table` library
    ```{r}
    library(data.table)
    ```

1. Read the **transactions.csv** file, from the **data** folder. Use the `fread()` function to load the data into a variable called `transactions`
    ```{r}
    transactions <- dir_ls("data", glob = "*.csv") %>%
       map(fread) %>%
       rbindlist()
    ```

1. Preview the data using `str()`
    ```{r}
    str(transactions)
    ```

1. Load the `dplyr` and `dtplyr` libraries
    ```{r}
    library(dplyr)
    library(dtplyr)
    ```

1. Use the `lazy_dt()` to "wrap" the `transactions` variable, into a new variable called `dt_transactions`
    ```{r}
    dt_transactions <- lazy_dt(transactions)
    ```


1. View the `dt_transactions` variable's structure with `str()`
    ```{r}
    str(dt_transactions)
    ```

## Object sizes
*Confirm that `dtplyr` is not making copies of the original `data.table`*

1. Load the `lobstr` library
    ```{r}
    library(lobstr)
    ```

1. Use `obj_size()` to obtain `transactions`'s size in memory
    ```{r}
    obj_size(transactions)
    ```

1. Use `obj_size()` to obtain `dt_transactions`'s size in memory
    ```{r}
    obj_size(dt_transactions)
    ```

1. Use `obj_size()` to obtain `dt_transactions` and `transactions` size in memory together
    ```{r}
    obj_size(transactions, dt_transactions)
    ```

## How `dtplyr` works
*Under the hood view of how `dtplyr` operates `data.table` objects*

1. Use `dplyr` verbs on top of `dt_transactions` to obtain the total sales by month
    ```{r}
    dt_transactions %>%
      group_by(order_date_month) %>%
      summarise(total_sales = sum(price))
    ```

1. Load the above code into a variable called `by_month`
    ```{r}
    by_month <- dt_transactions %>%
      group_by(order_date_month) %>%
      summarise(total_sales = sum(price))
    ```

1. Use `show_query()` to see the `data.table` code that `by_month` actually runs
    ```{r}
    show_query(by_month)
    ```

1. Use `str()` to view how `by_month`, instead of modifying the data, it only adds steps that will later be operated by `data.table`
    ```{r}
    str(by_month)
    ```

## Working with `dtplyr`
*Learn data conversion and basic visualization techniques*

1. Use `as_tibble()` to convert the results of `by_month` into a `tibble`
    ```{r}
    by_month %>%
      as_tibble()
    ```

1. Load the `ggplot2` library

    ```{r}
    library(ggplot2)
    ```

1. Use `as_tibble()` to convert before creating a line plot 
    ```{r}
    by_month %>%
      as_tibble() %>%
      ggplot() +
      geom_line(aes(order_date_month, total_sales))
    ```

## Pivot data
*Review a simple way to aggregate data faster, and then pivot it as a tibble*

1. Load the `tidyr` library
    ```{r}
    library(tidyr)
    ```

1. Group `db_transactions` by `order_date_month` and `order_date_day`, then aggregate `price` into `total_sales`
    ```{r}
    dt_transactions %>%
      group_by(order_date_month, order_date_day) %>% 
      summarise(total_sales = sum(price))
    ```

1. Copy the aggregation code above, **then collect it into a `tibble`**, and then use `pivot_wider()` to make the `order_date_day` the column headers.
    ```{r}
    dt_transactions %>%
      group_by(order_date_month, order_date_day) %>% 
      summarise(total_sales = sum(price)) %>%
      as_tibble() %>%
      pivot_wider(names_from = order_date_day, values_from = total_sales)
    ```


## The `mutate()` verb
*See how `dtplyr` creates a copy of the original `data.table` object in order to make the `mutate` operation work the same as it does on `dtplr`*

1. Use `mutate()` and `show_query()` to see the `copy()` command being used
    ```{r}
    dt_transactions %>%
      mutate(new_field = price / 2) %>%
      show_query()
    ```

1. Use `lazy_dt()` with the `immutable` argument set to `FALSE` to avoid the copy
    ```{r}
    lazy_dt(transactions, immutable = FALSE) %>%
      mutate(new_field = price / 2) %>%
      show_query()
    ```


